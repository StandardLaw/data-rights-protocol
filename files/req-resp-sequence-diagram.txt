title DRP Request Flow

Actor User
participant Authorized Agent 
participant DRP Network
participant Privacy Infrastructure 
participant Covered Business

note right of User
  dashed sequence lines are out of scope
  of DRP, specific to implementation of
  AA, PIP, resepectively
end note

opt regular background sync
  note over Privacy Infrastructure, Authorized Agent, DRP Network 
    (This has not been added to spec yet)
  end note
  Authorized Agent -> DRP Network: fetch businesses' API/etc\nfrom directory
  Privacy Infrastructure -> DRP Network: fetch agents' signing keys, etc\nfrom directory
end

User --> Authorized Agent: Onboard and verify\nidentity attributes once
User --> Authorized Agent: Requests data rights action to\nspecific business

opt AA has not interacted with this PIP before
  note over Privacy Infrastructure, Authorized Agent 
    (This sequence/endpoint has not been added to spec yet)
  end note
  Authorized Agent -> Privacy Infrastructure: fetch API token w/ signed request\nif this relationship is new
  Privacy Infrastructure -> Authorized Agent: Provide an API token which can be used to authenticate GET requests,\nprovide rate limiting on agent by agent basis, etc
end

Authorized Agent -> Privacy Infrastructure: construct a Data Rights Request and submits to API backend 
note over Privacy Infrastructure, Authorized Agent 
  POST /exercise
end note

Privacy Infrastructure --> Privacy Infrastructure: Verify signature of request, etc\npersist request
Privacy Infrastructure -> Authorized Agent: return request ID 
note over Privacy Infrastructure, Authorized Agent 
  [POST /exercise response, GET /status,\nPOST status_callback]
  request state: OPEN
end note

Privacy Infrastructure -->+ Covered Business: process is out of scope for protocol,\nsuggest integrating directly to existing DSR tooling
Covered Business --> Covered Business: process request through normal DSR process\nverify identity, collect records, process\nrequest using PIP tooling
Privacy Infrastructure -> Authorized Agent: Inform Agent request is acknowledged
note over Privacy Infrastructure, Authorized Agent 
  [POST /exercise response, GET /status,\nPOST status_callback]
  request state: IN PROGRESS
end note

opt optional additional verification flow
    Covered Business --> Privacy Infrastructure: need additional verification of consumer identity\ndirect user to visit a specific URL.
    Privacy Infrastructure -> Authorized Agent: Update requeset state to need_user_verification
    note over Privacy Infrastructure, Authorized Agent 
      POST status_callback, GET /status
      request state: IN PROGRESS
      needs_user_verification
    end note
    
    Authorized Agent --> User: Notify user of requirement
    User -> Covered Business: User visits URL in browser or webview and provides verification
    alt identity verification successful?
      Covered Business --> Privacy Infrastructure: verification complete
      Privacy Infrastructure -> Authorized Agent: move request forward in state machine
      note over Privacy Infrastructure, Authorized Agent 
        POST status_callback, GET /status
        request state: IN PROGRESS
      end note
    else
      Covered Business --> Privacy Infrastructure: Signal to close request
      Privacy Infrastructure -> Authorized Agent: Signal to close request
      note over Privacy Infrastructure, Authorized Agent 
        POST status_callback, GET /status
        request state: DENIED
        request sequence terminates
      end note
    end
end

Covered Business --> Covered Business: Process Request....
Covered Business -->- Privacy Infrastructure: Processing is completed
Privacy Infrastructure -> Authorized Agent: update request state, callback to Authorized Agent 
note over Privacy Infrastructure, Authorized Agent 
    POST status_callback, GET /status
    request state: FULFILLED
end note

Authorized Agent --> User: Notify user of completion
User -> Covered Business: User may have results URL to download or view in browser or user agent
